<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Downloader - Original Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .platform-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .platform-card:hover { transform: translateY(-5px); }
        
        .platform-card.active {
            border: 3px solid #667eea;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            outline: none;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .result-card { animation: slideUp 0.5s ease-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top-color: #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body class="antialiased">

    <!-- Toast -->
    <div id="toast" class="toast flex items-center space-x-3">
        <i id="toastIcon" class="fas fa-check-circle text-green-500 text-xl"></i>
        <span id="toastMessage" class="font-medium">Notifikasi</span>
    </div>

    <!-- Header -->
    <header class="glass-effect sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-500 rounded-xl flex items-center justify-center text-white text-xl">
                        <i class="fas fa-cloud-download-alt"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">AllDownloader</h1>
                        <p class="text-xs text-gray-500">Danzy API Edition</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-xs text-gray-600">API Online</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- Hero -->
        <div class="text-center mb-8 text-white">
            <h2 class="text-3xl sm:text-4xl font-bold mb-3">Universal Downloader</h2>
            <p class="text-base opacity-90 max-w-xl mx-auto">
                Menggunakan API danzy.web.id yang cepat dan stabil
            </p>
        </div>

        <!-- Platform Selector -->
        <div class="glass-effect rounded-2xl p-4 sm:p-6 mb-6 shadow-2xl">
            <h3 class="text-base font-semibold text-gray-700 mb-4 text-center">Pilih Platform</h3>
            
            <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-7 gap-3" id="platformContainer">
                <!-- TikTok -->
                <div class="platform-card active bg-white rounded-xl p-3 text-center shadow-md" data-platform="tiktok">
                    <div class="w-10 h-10 mx-auto mb-1 bg-black rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-tiktok"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">TikTok</span>
                    <div class="mt-1 flex justify-center gap-1">
                        <span class="api-badge bg-blue-100 text-blue-700 text-xs px-2 rounded-full">1</span>
                        <span class="api-badge bg-yellow-100 text-yellow-700 text-xs px-2 rounded-full">2</span>
                    </div>
                </div>

                <!-- YouTube -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md" data-platform="youtube">
                    <div class="w-10 h-10 mx-auto mb-1 bg-red-600 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-youtube"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">YouTube</span>
                    <div class="mt-1 flex justify-center gap-1">
                        <span class="api-badge bg-green-100 text-green-700 text-xs px-2 rounded-full">MP4</span>
                        <span class="api-badge bg-purple-100 text-purple-700 text-xs px-2 rounded-full">MP3</span>
                    </div>
                </div>

                <!-- Instagram -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md" data-platform="instagram">
                    <div class="w-10 h-10 mx-auto mb-1 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-instagram"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">IG</span>
                    <div class="mt-1 flex justify-center">
                        <span class="api-badge bg-blue-100 text-blue-700 text-xs px-2 rounded-full">API</span>
                    </div>
                </div>

                <!-- Pinterest -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md opacity-50" data-platform="pinterest">
                    <div class="w-10 h-10 mx-auto mb-1 bg-red-700 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-pinterest-p"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">Pinterest</span>
                    <div class="mt-1 flex justify-center">
                        <span class="api-badge bg-red-100 text-red-700 text-xs px-2 rounded-full">OFF</span>
                    </div>
                </div>

                <!-- Spotify -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md opacity-50" data-platform="spotify">
                    <div class="w-10 h-10 mx-auto mb-1 bg-green-500 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-spotify"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">Spotify</span>
                    <div class="mt-1 flex justify-center">
                        <span class="api-badge bg-red-100 text-red-700 text-xs px-2 rounded-full">OFF</span>
                    </div>
                </div>

                <!-- MediaFire -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md" data-platform="mediafire">
                    <div class="w-10 h-10 mx-auto mb-1 bg-blue-500 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fas fa-fire"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">MF</span>
                    <div class="mt-1 flex justify-center">
                        <span class="api-badge bg-blue-100 text-blue-700 text-xs px-2 rounded-full">API</span>
                    </div>
                </div>

                <!-- Facebook -->
                <div class="platform-card bg-white rounded-xl p-3 text-center shadow-md" data-platform="facebook">
                    <div class="w-10 h-10 mx-auto mb-1 bg-blue-600 rounded-full flex items-center justify-center text-white text-lg">
                        <i class="fab fa-facebook-f"></i>
                    </div>
                    <span class="font-semibold text-gray-700 text-xs block">FB</span>
                    <div class="mt-1 flex justify-center">
                        <span class="api-badge bg-blue-100 text-blue-700 text-xs px-2 rounded-full">API</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="glass-effect rounded-2xl p-6 shadow-2xl mb-6">
            <div class="max-w-3xl mx-auto">
                <label class="block text-gray-700 font-semibold mb-2 text-sm sm:text-base">
                    <i class="fas fa-link mr-2 text-purple-600"></i>
                    URL <span id="platformLabel" class="text-purple-600 bg-purple-100 px-2 py-1 rounded-full text-xs ml-2">TikTok</span>
                </label>
                
                <div class="relative">
                    <input type="url" id="urlInput" 
                           class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 input-focus text-gray-700 text-sm sm:text-base pr-28"
                           placeholder="https://www.tiktok.com/@username/video/123456...">
                    <button id="searchBtn" class="absolute right-2 top-2 bottom-2 download-btn text-white px-4 rounded-lg font-semibold text-sm flex items-center space-x-1">
                        <i class="fas fa-search"></i>
                        <span class="hidden sm:inline">Analisis</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-2">
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-check-circle mr-1 text-green-500"></i>
                        <span id="hintText">Video TikTok tanpa watermark</span>
                    </p>
                    <button id="pasteBtn" class="text-xs text-purple-600 hover:text-purple-800 font-medium">
                        <i class="fas fa-paste mr-1"></i>Paste
                    </button>
                </div>

                <!-- YouTube Format Selector -->
                <div id="ytSelector" class="hidden mt-3 flex gap-2">
                    <button id="btnMp4" class="flex-1 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold">
                        <i class="fas fa-video mr-1"></i>MP4 Video
                    </button>
                    <button id="btnMp3" class="flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold">
                        <i class="fas fa-music mr-1"></i>MP3 Audio
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingSection" class="hidden glass-effect rounded-2xl p-8 text-center shadow-2xl mb-6">
            <div class="loading-spinner mx-auto mb-3"></div>
            <h3 class="text-lg font-semibold text-gray-700 mb-1" id="loadingText">Menganalisis...</h3>
            <p class="text-sm text-gray-500" id="loadingSub">Menghubungi API...</p>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden glass-effect rounded-2xl p-4 sm:p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4 border-b pb-3">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                        <i class="fas fa-check text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm sm:text-base">Hasil</h3>
                        <p class="text-xs text-gray-500" id="usedApi">API</p>
                    </div>
                </div>
                <button id="closeResults" class="w-8 h-8 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="resultsContent" class="space-y-3"></div>
        </div>

        <!-- Error -->
        <div id="errorSection" class="hidden glass-effect rounded-2xl p-6 shadow-2xl border-l-4 border-red-500 mb-6">
            <div class="flex items-center space-x-2 mb-2">
                <i class="fas fa-exclamation-triangle text-red-500"></i>
                <h3 class="font-bold text-gray-800">Gagal</h3>
            </div>
            <p id="errorMessage" class="text-sm text-gray-600 mb-3">Terjadi kesalahan</p>
            <button id="retryBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600">
                <i class="fas fa-redo mr-1"></i>Coba Lagi
            </button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-12 bg-white bg-opacity-10 backdrop-blur-lg text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm mb-1">&copy; 2024 AllDownloader</p>
            <p class="text-xs opacity-75">Powered by danzy.web.id API</p>
        </div>
    </footer>

    <script>
        // ============================================
        // API CONFIGURATION - ORIGINAL PARSER (WORKING)
        // ============================================
        
        const API_CONFIG = {
            // TIKTOK - API LAMA (TETAP)
            tiktok: {
                primary: {
                    name: 'tikwm.com',
                    url: 'https://tikwm.com/api/',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => ({
                        success: d.code === 0,
                        videoUrl: d.data?.play,
                        audioUrl: d.data?.music,
                        thumbnail: d.data?.cover,
                        author: d.data?.author?.nickname,
                        title: d.data?.title
                    })
                },
                backup: {
                    name: 'snapx.cab',
                    url: 'https://snapx.cab/api/tiktok',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => ({
                        success: !!d.url,
                        videoUrl: d.url,
                        audioUrl: d.audioUrl,
                        thumbnail: d.thumbnail,
                        author: d.author,
                        title: d.title
                    })
                }
            },
            
            // YOUTUBE - ORIGINAL WORKING PARSER
            youtube: {
                mp4: {
                    name: 'danzy.web.id (MP4)',
                    url: 'https://api.danzy.web.id/api/download/ytmp4',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => ({
                        success: d.status === true || d.success === true || !!d.result || !!d.data,
                        title: d.result?.title || d.data?.title || d.title || 'YouTube Video',
                        thumbnail: d.result?.thumbnail || d.data?.thumbnail || d.thumbnail,
                        downloadUrl: d.result?.url || d.result?.link || d.data?.url || d.data?.link || d.url,
                        quality: d.result?.quality || d.data?.quality || 'HD',
                        format: 'mp4'
                    })
                },
                mp3: {
                    name: 'danzy.web.id (MP3)',
                    url: 'https://api.danzy.web.id/api/download/ytmp3',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => ({
                        success: d.status === true || d.success === true || !!d.result || !!d.data,
                        title: d.result?.title || d.data?.title || d.title || 'YouTube Audio',
                        thumbnail: d.result?.thumbnail || d.data?.thumbnail || d.thumbnail,
                        downloadUrl: d.result?.url || d.result?.link || d.data?.url || d.data?.link || d.url,
                        quality: 'MP3',
                        format: 'mp3'
                    })
                }
            },
            
            // INSTAGRAM - ORIGINAL
            instagram: {
                primary: {
                    name: 'danzy.web.id',
                    url: 'https://api.danzy.web.id/api/download/instagram',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => {
                        const result = d.result || d.data;
                        const items = Array.isArray(result) ? result : (result ? [result] : []);
                        
                        return {
                            success: items.length > 0 && (items[0].url || items[0].link || items[0].src),
                            items: items.map(i => ({
                                type: i.type || (i.url?.includes('.mp4') ? 'video' : 'image'),
                                url: i.url || i.link || i.src,
                                thumbnail: i.thumbnail || i.url
                            })).filter(i => i.url)
                        };
                    }
                }
            },
            
            // FACEBOOK - ORIGINAL
            facebook: {
                primary: {
                    name: 'danzy.web.id',
                    url: 'https://api.danzy.web.id/api/download/facebook',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => {
                        const result = d.result || d.data;
                        const hd = result?.hd || result?.url || result?.link;
                        const sd = result?.sd;
                        
                        return {
                            success: !!(hd || sd),
                            title: result?.title || d.title || 'Facebook Video',
                            thumbnail: result?.thumbnail || d.thumbnail,
                            formats: [
                                { quality: 'HD', url: hd },
                                { quality: 'SD', url: sd }
                            ].filter(f => f.url)
                        };
                    }
                }
            },
            
            // MEDIAFIRE - ORIGINAL WORKING PARSER
            mediafire: {
                primary: {
                    name: 'danzy.web.id',
                    url: 'https://api.danzy.web.id/api/download/mediafire',
                    method: 'GET',
                    params: (u) => `?url=${encodeURIComponent(u)}`,
                    parser: (d) => ({
                        success: d.status === true || d.success === true || !!(d.result?.url || d.data?.url),
                        filename: d.result?.filename || d.data?.filename || d.result?.name || d.data?.name || d.filename || 'File',
                        size: d.result?.size || d.data?.size || d.size || 'Unknown',
                        downloadUrl: d.result?.url || d.result?.link || d.data?.url || d.data?.link || d.url
                    })
                }
            },
            
            // PINTEREST - DISABLED (API TIDAK STABIL)
            pinterest: null,
            
            // SPOTIFY - DISABLED (API TIDAK STABIL)
            spotify: null
        };

        // ============================================
        // STATE
        // ============================================
        
        let currentPlatform = 'tiktok';
        let lastUrl = '';
        let ytFormat = 'mp4';
        let currentApiUsed = '';

        const hints = {
            tiktok: 'Video TikTok tanpa watermark',
            youtube: 'Pilih format MP3 atau MP4',
            instagram: 'Foto, video, reels, carousel',
            pinterest: 'Service temporarily unavailable',
            spotify: 'Service temporarily unavailable',
            mediafire: 'Direct download file',
            facebook: 'Video Facebook HD/SD'
        };

        const placeholders = {
            tiktok: 'https://www.tiktok.com/@username/video/...',
            youtube: 'https://youtube.com/watch?v=...',
            instagram: 'https://instagram.com/p/...',
            pinterest: 'https://pinterest.com/pin/...',
            spotify: 'https://open.spotify.com/track/...',
            mediafire: 'https://mediafire.com/file/...',
            facebook: 'https://facebook.com/watch?v=...'
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing AllDownloader...');
            
            // Attach platform click events
            document.querySelectorAll('.platform-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    const platform = this.getAttribute('data-platform');
                    if (platform === 'pinterest' || platform === 'spotify') {
                        showToast('Fitur ini sedang dalam perbaikan', 'error');
                        return;
                    }
                    selectPlatform(platform, this);
                });
            });
            
            // Attach other events
            document.getElementById('searchBtn').addEventListener('click', startDownload);
            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startDownload();
            });
            document.getElementById('pasteBtn').addEventListener('click', pasteFromClipboard);
            document.getElementById('btnMp4').addEventListener('click', () => setYtFormat('mp4'));
            document.getElementById('btnMp3').addEventListener('click', () => setYtFormat('mp3'));
            document.getElementById('closeResults').addEventListener('click', clearResults);
            document.getElementById('retryBtn').addEventListener('click', retryDownload);
            
            // Set initial active
            const tiktokCard = document.querySelector('[data-platform="tiktok"]');
            if (tiktokCard) tiktokCard.classList.add('active');
        });

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function selectPlatform(platform, el) {
            console.log('Selecting platform:', platform);
            
            // FIX: Clear URL dan results saat ganti platform
            document.getElementById('urlInput').value = '';
            clearResults();
            
            currentPlatform = platform;
            
            // Update visual active state
            document.querySelectorAll('.platform-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            // Update UI text
            document.getElementById('platformLabel').textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
            document.getElementById('hintText').textContent = hints[platform];
            document.getElementById('urlInput').placeholder = placeholders[platform];
            
            // Show/hide YouTube selector
            document.getElementById('ytSelector').style.display = platform === 'youtube' ? 'flex' : 'none';
            
            // Reset format
            if (platform === 'youtube') setYtFormat('mp4');
        }

        function setYtFormat(fmt) {
            ytFormat = fmt;
            document.getElementById('btnMp4').className = fmt === 'mp4' 
                ? 'flex-1 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold'
                : 'flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold';
            document.getElementById('btnMp3').className = fmt === 'mp3'
                ? 'flex-1 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold'
                : 'flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-semibold';
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('urlInput').value = text;
                showToast('URL dipaste!', 'success');
            } catch (err) {
                showToast('Clipboard tidak diizinkan', 'error');
            }
        }

        // ============================================
        // API FUNCTIONS (ORIGINAL WORKING VERSION)
        // ============================================
        
        async function tryApi(config, url) {
            const fullUrl = config.url + config.params(url);
            console.log(`Trying ${config.name}:`, fullUrl);
            
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);
            
            try {
                const res = await fetch(fullUrl, {
                    method: config.method,
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timeout);
                
                console.log(`${config.name} HTTP Status:`, res.status);
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                console.log(`${config.name} Response:`, data);
                
                const parsed = config.parser(data);
                console.log(`${config.name} Parsed:`, parsed);
                
                if (!parsed.success) throw new Error('Parser returned success=false');
                
                return { success: true, data: parsed, source: config.name };
                
            } catch (err) {
                console.error(`${config.name} Error:`, err);
                return { success: false, error: err.message, source: config.name };
            }
        }

        async function fetchWithBackup(platform, url) {
            const cfg = API_CONFIG[platform];
            if (!cfg) throw new Error('Platform tidak didukung');
            
            // YouTube handling
            if (platform === 'youtube') {
                const ytConfig = ytFormat === 'mp4' ? cfg.mp4 : cfg.mp3;
                document.getElementById('loadingSub').textContent = `Mencoba YouTube ${ytFormat.toUpperCase()}...`;
                
                const result = await tryApi(ytConfig, url);
                
                if (!result.success) throw new Error(`YouTube ${ytFormat.toUpperCase()} gagal: ${result.error}`);
                
                currentApiUsed = result.source;
                return result.data;
            }
            
            // TikTok dengan backup
            if (platform === 'tiktok') {
                const apis = [cfg.primary, cfg.backup];
                for (let i = 0; i < apis.length; i++) {
                    document.getElementById('loadingSub').textContent = `Mencoba ${apis[i].name}...`;
                    const result = await tryApi(apis[i], url);
                    
                    if (result.success) {
                        currentApiUsed = result.source;
                        if (i > 0) showToast(`Menggunakan ${result.source}`, 'info');
                        return result.data;
                    }
                }
                throw new Error('Semua API TikTok gagal');
            }
            
            // Platform lain (hanya 1 API)
            const api = cfg.primary;
            document.getElementById('loadingSub').textContent = `Mencoba ${api.name}...`;
            
            const result = await tryApi(api, url);
            
            if (!result.success) throw new Error(`${api.name} gagal: ${result.error}`);
            
            currentApiUsed = result.source;
            return result.data;
        }

        // ============================================
        // MAIN FUNCTION
        // ============================================
        
        async function startDownload() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return showToast('Masukkan URL!', 'error');
            
            lastUrl = url;
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            
            try {
                const data = await fetchWithBackup(currentPlatform, url);
                document.getElementById('loadingSection').classList.add('hidden');
                
                showResults(data);
                document.getElementById('usedApi').textContent = `Via: ${currentApiUsed}`;
                showToast('Berhasil!', 'success');
                
            } catch (err) {
                console.error('Download error:', err);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = err.message;
                showToast('Gagal: ' + err.message, 'error');
            }
        }

        // ============================================
        // RENDER FUNCTIONS (ORIGINAL)
        // ============================================
        
        function showResults(data) {
            const div = document.getElementById('resultsSection');
            const content = document.getElementById('resultsContent');
            div.classList.remove('hidden');
            
            const renderers = {
                tiktok: () => `
                    <div class="result-card bg-white rounded-xl p-4 shadow">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="sm:w-1/3">
                                <div class="aspect-[9/16] bg-gray-100 rounded-lg overflow-hidden">
                                    ${data.thumbnail ? 
                                        `<img src="${data.thumbnail}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                                        '<div class="flex items-center justify-center h-full text-gray-400"><i class="fas fa-video text-3xl"></i></div>'
                                    }
                                </div>
                            </div>
                            <div class="sm:w-2/3 space-y-3">
                                <h4 class="font-bold text-gray-800 text-sm">${data.title || 'TikTok Video'}</h4>
                                <p class="text-xs text-gray-500">${data.author || '@user'}</p>
                                <div class="flex gap-2">
                                    <span class="bg-gradient-to-r from-green-400 to-green-600 text-white px-2 py-1 rounded-full text-xs">HD</span>
                                    <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">No WM</span>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <a href="${data.videoUrl}" target="_blank" rel="noopener noreferrer" class="download-btn text-white py-2 rounded-lg text-center text-sm font-semibold block">
                                        <i class="fas fa-video mr-1"></i>Video
                                    </a>
                                    ${data.audioUrl ? `
                                    <a href="${data.audioUrl}" target="_blank" rel="noopener noreferrer" class="bg-gray-100 text-gray-700 py-2 rounded-lg text-center text-sm font-semibold hover:bg-gray-200 block">
                                        <i class="fas fa-music mr-1"></i>Audio
                                    </a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`,
                
                youtube: () => `
                    <div class="result-card bg-white rounded-xl p-4 shadow border-l-4 border-red-600">
                        <div class="flex gap-4">
                            <div class="w-24 h-24 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden">
                                ${data.thumbnail ? 
                                    `<img src="${data.thumbnail}" class="w-full h-full object-cover" onerror="this.style.display='none'">` : 
                                    '<div class="flex items-center justify-center h-full text-gray-400"><i class="fab fa-youtube text-2xl"></i></div>'
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-2 mb-2">${data.title || 'YouTube Video'}</h4>
                                <span class="${data.format === 'mp3' ? 'bg-gradient-to-r from-orange-400 to-yellow-400' : 'bg-gradient-to-r from-green-400 to-emerald-500'} text-white px-2 py-1 rounded-full text-xs">${data.quality || 'HD'}</span>
                                <a href="${data.downloadUrl}" target="_blank" rel="noopener noreferrer" class="mt-2 block w-full download-btn text-white py-2 rounded-lg text-center text-sm font-semibold">
                                    <i class="fas fa-download mr-1"></i>Unduh ${data.format?.toUpperCase() || 'VIDEO'}
                                </a>
                            </div>
                        </div>
                    </div>`,
                
                instagram: () => data.items && data.items.length > 0 ? `
                    <div class="result-card bg-white rounded-xl p-4 shadow">
                        <h4 class="font-bold text-gray-800 mb-3 text-sm">${data.items.length} Media Ditemukan</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-64 overflow-y-auto">
                            ${data.items.map((item, i) => `
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden group block">
                                    ${item.type === 'video' ? '<div class="absolute inset-0 flex items-center justify-center z-10"><i class="fas fa-play-circle text-white text-2xl drop-shadow-lg"></i></div>' : ''}
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition flex items-center justify-center opacity-0 group-hover:opacity-100">
                                        <i class="fas fa-download text-white"></i>
                                    </div>
                                    <div class="absolute top-1 right-1 bg-black text-white text-xs px-1 rounded z-20">${i + 1}</div>
                                </a>
                            `).join('')}
                        </div>
                    </div>` : '<div class="text-red-500 text-center py-4">Tidak ada media ditemukan</div>',
                
                facebook: () => data.formats && data.formats.length > 0 ? `
                    <div class="result-card bg-white rounded-xl p-4 shadow border-l-4 border-blue-600">
                        <h4 class="font-bold text-gray-800 text-sm mb-3 line-clamp-2">${data.title || 'Facebook Video'}</h4>
                        ${data.thumbnail ? `
                        <div class="mb-3 aspect-video bg-gray-100 rounded-lg overflow-hidden">
                            <img src="${data.thumbnail}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                        </div>` : ''}
                        <div class="grid grid-cols-2 gap-2">
                            ${data.formats.map(f => `
                                <a href="${f.url}" target="_blank" rel="noopener noreferrer" class="bg-blue-50 border-2 border-blue-200 hover:border-blue-400 rounded-lg p-3 text-center transition block">
                                    <div class="font-bold text-blue-700 text-lg">${f.quality}</div>
                                    <div class="text-xs text-blue-500">Kualitas ${f.quality}</div>
                                </a>
                            `).join('')}
                        </div>
                    </div>` : '<div class="text-red-500 text-center py-4">Format tidak ditemukan</div>',
                
                mediafire: () => data.downloadUrl ? `
                    <div class="result-card bg-white rounded-xl p-4 shadow border-l-4 border-blue-500">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                <i class="fas fa-file-archive text-xl"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 text-sm truncate">${data.filename}</h4>
                                <p class="text-xs text-gray-500">${data.size}</p>
                            </div>
                        </div>
                        <a href="${data.downloadUrl}" target="_blank" rel="noopener noreferrer" class="block w-full download-btn text-white py-3 rounded-lg text-center font-semibold">
                            <i class="fas fa-cloud-download-alt mr-2"></i>Download File
                        </a>
                    </div>` : '<div class="text-red-500 text-center py-4">Link download tidak ditemukan</div>'
            };
            
            content.innerHTML = (renderers[currentPlatform] || (() => '<div class="text-red-500 text-center py-4">Platform tidak didukung</div>'))();
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearResults() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
        }

        function retryDownload() {
            if (lastUrl) {
                document.getElementById('urlInput').value = lastUrl;
                startDownload();
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const text = document.getElementById('toastMessage');
            
            text.textContent = msg;
            icon.className = `fas ${
                type === 'error' ? 'fa-exclamation-circle text-red-500' : 
                type === 'info' ? 'fa-info-circle text-blue-500' : 
                'fa-check-circle text-green-500'
            } text-xl`;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>

</body>
</html>
